apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-cmp-proxy-nginx
  namespace: vault
data:
  default.conf: |
    server {
      listen 8080;

      client_max_body_size 10m;

      # Optional hardening (currently disabled): allow only Vault PKI CMPv2 API paths.
      # Keep this block for future re-enable if strict path filtering is required.
      #
      # location = /v1/pki/cmp {
      #   proxy_pass https://vault.vault.svc.cluster.local:8200;
      #   proxy_http_version 1.1;
      #
      #   proxy_ssl_server_name on;
      #   proxy_ssl_name vault.vault.svc.cluster.local;
      #   proxy_ssl_verify on;
      #   proxy_ssl_trusted_certificate /etc/nginx/vault-ca/ca.crt;
      #
      #   proxy_set_header Host vault.vault.svc.cluster.local;
      #   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      #   proxy_set_header X-Forwarded-Proto http;
      # }
      #
      # location ~ ^/v1/pki/roles/[^/]+/cmp$ {
      #   proxy_pass https://vault.vault.svc.cluster.local:8200;
      #   proxy_http_version 1.1;
      #
      #   proxy_ssl_server_name on;
      #   proxy_ssl_name vault.vault.svc.cluster.local;
      #   proxy_ssl_verify on;
      #   proxy_ssl_trusted_certificate /etc/nginx/vault-ca/ca.crt;
      #
      #   proxy_set_header Host vault.vault.svc.cluster.local;
      #   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      #   proxy_set_header X-Forwarded-Proto http;
      # }

      # Generic forwarding (used when strict path filtering is disabled).
      location / {
        proxy_pass https://vault.vault.svc.cluster.local:8200;
        proxy_http_version 1.1;

        proxy_ssl_server_name on;
        proxy_ssl_name vault.vault.svc.cluster.local;
        proxy_ssl_verify on;
        proxy_ssl_trusted_certificate /etc/nginx/vault-ca/ca.crt;

        proxy_set_header Host vault.vault.svc.cluster.local;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;
      }

      # Health check path for quick validation of proxy reachability.
      location /healthz {
        return 200 "ok\n";
      }

      # Hardened default deny (disabled while generic forwarding is enabled).
      # location / {
      #   return 403;
      # }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vault-cmp-proxy
  namespace: vault
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vault-cmp-proxy
  template:
    metadata:
      labels:
        app: vault-cmp-proxy
    spec:
      containers:
        - name: nginx
          image: nginx:1.27-alpine
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 250m
              memory: 256Mi
          ports:
            - containerPort: 8080
              name: http
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
            - name: vault-ca
              mountPath: /etc/nginx/vault-ca
              readOnly: true
      volumes:
        - name: nginx-config
          configMap:
            name: vault-cmp-proxy-nginx
        - name: vault-ca
          secret:
            secretName: vault-server-tls
            items:
              - key: ca.crt
                path: ca.crt
---
apiVersion: v1
kind: Service
metadata:
  name: vault-cmp-proxy
  namespace: vault
spec:
  selector:
    app: vault-cmp-proxy
  ports:
    - name: http
      port: 8080
      targetPort: 8080
